<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Matt Peddie, Kittyhawk mpeddie@gmail.com" />
  <meta name="date" content="2018-07-10" />
  <title>SAT Modulo Theories for Fun and Profit</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">SAT Modulo Theories for Fun and Profit</h1>
  <p class="author">
Matt Peddie, Kittyhawk <a href="mailto:mpeddie@gmail.com">mpeddie@gmail.com</a>
  </p>
  <p class="date">10 July 2018</p>
</div>
<div class="slide section level1">

<?xml version='1.0' encoding='UTF-8'?>
<!-- This file was generated by dvisvgm 1.15.1 -->
<svg height="0pt" version="1.1" viewBox="0 0 0 0" width="0pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id='page1' transform='matrix(1.13 0 0 1.13 0 0)'/>
</svg>
</div>
<div id="overview" class="slide section level1">
<h1>Overview</h1>
<!-- Today's talk touches on a number of topics dear to our hearts as -->
<!-- functional programmers.  In particular, a lot of functional -->
<!-- programmers talk about proving things.  Usually this means either -->
<!-- proving something very simple with Haskell's types or proving -->
<!-- something a lot more complex in a language like Agda or Coq.  I'm -->
<!-- going to talk about a way to automatically prove things of moderate -->
<!-- complexity using tools that are not built into a language, without -->
<!-- writing proofs (only theorems).  A great way to make this happen, for -->
<!-- someone unaccustomed to the external tools, is to do another trick we -->
<!-- as functional programmers talk about a lot, which is to use a -->
<!-- domain-specific language. -->
<!-- I apologize in advance for a few things: I will assume basic knowledge -->
<!-- of Haskell; one of the examples applies some (basic) physics, and I -->
<!-- won't have time to go into detail during the talk; many of the -->
<!-- examples are cribbed from the SBV documentation, partly because it's -->
<!-- so good and partly because it contains a much wider variety of -->
<!-- problems than I've personally used SBV to solve; I don't understand -->
<!-- SAT and SMT well enough to give a really great explanation of the -->
<!-- underlying theory (everything I know about SMT I learned while trying -->
<!-- to do increasingly complex proofs and optimization problems on -->
<!-- floating-point programs). -->
<ul>
<li>What is
<ul>
<li>SAT</li>
<li>SMT</li>
<li>SBV</li>
</ul></li>
<li>Proofs
<ul>
<li>Simple proofs</li>
<li>Stability proof for a feedback controller</li>
</ul></li>
<li><p>Code generation</p></li>
<li><p>Constraint solving</p></li>
<li><p>Optimization</p></li>
</ul>
</div>
<div id="sat" class="slide section level1">
<h1>SAT</h1>
<p>Boolean <strong>SAT</strong>isfiability</p>
<p>For some formula involving logical variables and logical connectives, is there an assignment of boolean values to the variables that makes the formula <code>true</code>?</p>
</div>
<div id="sat-1" class="slide section level1">
<h1>SAT</h1>
<p>Boolean <strong>SAT</strong>isfiability</p>
<p>For some formula involving logical variables and logical connectives, is there an assignment of boolean values to the variables that makes the formula <code>true</code>?</p>
<p>Example:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cdisplaystyle%7BA%20%5Cland%20%5Cleft%28B%20%5Clor%20%5Cleft%28%5Cneg%20C%20%5Cright%29%5Cright%29%7D" alt="\Huge \displaystyle{A \land \left(B \lor \left(\neg C \right)\right)}" title="\Huge \displaystyle{A \land \left(B \lor \left(\neg C \right)\right)}" /></p>
</div>
<div id="sat-2" class="slide section level1">
<h1>SAT</h1>
<p>Boolean <strong>SAT</strong>isfiability</p>
<p>For some formula involving logical variables and logical connectives, is there an assignment of boolean values to the variables that makes the formula <code>true</code>?</p>
<p>Example:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cdisplaystyle%7BA%20%5Cland%20%5Cleft%28B%20%5Clor%20%5Cleft%28%5Cneg%20C%20%5Cright%29%5Cright%29%7D" alt="\Huge \displaystyle{A \land \left(B \lor \left(\neg C \right)\right)}" title="\Huge \displaystyle{A \land \left(B \lor \left(\neg C \right)\right)}" /></p>
<ul>
<li>Variables: <code>A</code>, <code>B</code>, <code>C</code> . . .</li>
<li>Connectives are always <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cland" alt="\Huge \land" title="\Huge \land" /> (<code>AND</code>), <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Clor" alt="\Huge \lor" title="\Huge \lor" /> (<code>OR</code>) and <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cneg" alt="\Huge \neg" title="\Huge \neg" /> (<code>NOT</code>).</li>
</ul>
<!-- SAT was the first problem to be proved to be NP-complete.  So assuming -->
<!-- $\Huge P \neq NP$, this problem can't be solved in polynomial time -->
<!-- (in the size of the formula).  Sad times! -->
<!-- You can find free and commercial solvers for this problem that are -->
<!-- quite fast for many practical problems.  I haven't used any myself, so -->
<!-- I can't recommend any. -->
</div>
<div id="smt" class="slide section level1">
<h1>SMT</h1>
<p><strong>S</strong>AT <strong>M</strong>odulo <strong>T</strong>heories</p>
<p>Take a SAT formula and replace some or all of the variables with predicates over a more complicated theory. Example:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%282%2Ax%20%2B%20y%20%3C%200%29%20%5Cland%20%28x%20%5Cgeq%200%29" alt="\Huge \left(2*x + y &lt; 0) \land (x \geq 0)" title="\Huge \left(2*x + y &lt; 0) \land (x \geq 0)" /></p>
<!-- The "more complicated theory" in this case is linear arithmetic over -->
<!-- integers (or real numbers?). -->
<!-- Obviously this problem is no easier than SAT, and in many cases it's -->
<!-- much harder.  For many "more complicated theories," you can replace -->
<!-- e.g. a 32-bit integer with 32 boolean variables, addition with the -->
<!-- appropriate full-adder function, and use a SAT solver to solve. -->
<!-- Modern solvers know important axioms about the underlying "more -->
<!-- complicated theories" to do better than this. -->
</div>
<div id="smt-1" class="slide section level1">
<h1>SMT</h1>
<p><strong>S</strong>AT <strong>M</strong>odulo <strong>T</strong>heories</p>
<p>Take a SAT formula and replace some or all of the variables with predicates over a more complicated theory. Example:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%282%2Ax%20%2B%20y%20%3C%200%29%20%5Cland%20%28x%20%5Cgeq%200%29" alt="\Huge \left(2*x + y &lt; 0) \land (x \geq 0)" title="\Huge \left(2*x + y &lt; 0) \land (x \geq 0)" /></p>
<p>“More complicated theories” include</p>
<ul>
<li>algebraic real numbers</li>
<li>floating-point arithmetic</li>
<li>integer arithmetic</li>
<li>arrays</li>
<li>bitvectors</li>
<li>“uninterpreted functions”</li>
<li>strings (Z3)</li>
</ul>
</div>
<div id="smtlib" class="slide section level1">
<h1>SMTLIB</h1>
<!-- Basically this defines a standard way to write out SMT problems
that all solvers can accept.  This lets you quickly change out one
solver for another. -->
<p><img src="smtlib-logics.png" title="Diagram of SMTLIB logics" /></p>
<p><a href="http://smtlib.cs.uiowa.edu/Logics/logics.png" class="uri">http://smtlib.cs.uiowa.edu/Logics/logics.png</a></p>
</div>
<div id="smtlib-1" class="slide section level1">
<h1>SMTLIB</h1>
<p><img src="smtlib-logics.png" title="Diagram of SMTLIB logics" /></p>
<p><a href="http://smtlib.cs.uiowa.edu/Logics/logics.png" class="uri">http://smtlib.cs.uiowa.edu/Logics/logics.png</a></p>
<p>Examples:</p>
<ul>
<li><code>QF_BV</code> is “quantifier-free formulae over the theory of fixed-size bit-vectors.”</li>
</ul>
</div>
<div id="smtlib-2" class="slide section level1">
<h1>SMTLIB</h1>
<p><img src="smtlib-logics.png" title="Diagram of SMTLIB logics" /></p>
<p><a href="http://smtlib.cs.uiowa.edu/Logics/logics.png" class="uri">http://smtlib.cs.uiowa.edu/Logics/logics.png</a></p>
<p>Examples:</p>
<ul>
<li><p><code>QF_BV</code> is “quantifier-free formulae over the theory of fixed-size bit-vectors.”</p></li>
<li><p><code>QF_NIA</code> is “quantifier-free formulae over the theory of nonlinear integer arithmetic.”</p></li>
</ul>
</div>
<div id="smtlib-3" class="slide section level1">
<h1>SMTLIB</h1>
<p><img src="smtlib-logics.png" title="Diagram of SMTLIB logics" /></p>
<p><a href="http://smtlib.cs.uiowa.edu/Logics/logics.png" class="uri">http://smtlib.cs.uiowa.edu/Logics/logics.png</a></p>
<p>Examples:</p>
<ul>
<li><p><code>QF_BV</code> is “quantifier-free formulae over the theory of fixed-size bit-vectors.”</p></li>
<li><p><code>QF_NIA</code> is “quantifier-free formulae over the theory of nonlinear integer arithmetic.”</p></li>
<li><p><code>QF_FPBV</code> is a combination of floating point (<code>FP</code>) and array and bit-vector (<code>BV</code>) theories</p></li>
</ul>
<p>These specify the underlying theories from which the predicates in the boolean formula may be drawn.</p>
<!-- "Quantifier-free" here means that quantifiers like $\Huge \forall$ and -->
<!-- $\Huge \exists$ can't be incorporated into the individual predicates; -->
<!-- obviously if we want to prove something, in the end we'll write a -->
<!-- $\Huge \forall$ at the top level of our proof.  (If I understand -->
<!-- correctly, the `QF_` restriction corresponds to restricting your -->
<!-- Haskell programs to rank-1 types, for Curry-Howard fans.) -->
<!-- Solvers typically allow combinations of underlying theories, -->
<!-- e.g. `QF_FPBV` combines quantifier-free formulas from the -->
<!-- floating-point, array and bit-vector theories. -->
<!-- Z3 and I think Yices have "default modes" which combine all available -->
<!-- theories in some presumably clever way.  This matters -- sometimes you -->
<!-- can't find an official SMTLIB logic that simultaneously encompasses -->
<!-- the full range of theories involved with the problem you want to -->
<!-- solve, but if you avoid specifying a logic, Z3's default mode will -->
<!-- crunch right through it. -->
</div>
<div id="sbv" class="slide section level1">
<h1>SBV</h1>
<p><strong>S</strong>MT-<strong>B</strong>ased <strong>V</strong>erification – a Haskell DSL for working with SMT solvers.</p>
<p>Write your programs in Haskell, run them in SMTLIB.</p>
<p>Additional features:</p>
<ul>
<li>Constraint solving</li>
<li>Overflow/underflow checking</li>
<li>C code generation</li>
<li>Optimization</li>
<li>Parallel solvers (race-mode or check-mode)</li>
</ul>
<p>SBV uses Z3 by default, but it supports several others as well.</p>
</div>
<div id="basic-sbv-interface" class="slide section level1">
<h1>Basic SBV interface</h1>
<!-- A nice type-safe interface to an untyped core language.  The `SBV` -->
<!-- data type wraps any user-provided type when we want to reason about -->
<!-- it, e.g. `SBV Int32` (`~ SInt32`), `SBV Bool` (`~ SBool`), `SBV -->
<!-- Double` (~ `SDouble`) and so on. -->
<p>Simple DSL:</p>
<pre><code>data SBV a</code></pre>
<p><code>a</code> ranges over types we reason about:</p>
<ul>
<li><code>Double</code></li>
<li><code>Bool</code></li>
<li><code>Int32</code></li>
<li><code>Word8</code></li>
</ul>
<p>etc. These must be instances of a class <code>SymWord</code>.</p>
<pre><code>type SDouble = SBV Double
type SBool   = SBV Bool
...</code></pre>
</div>
<div id="basic-sbv-interface-1" class="slide section level1">
<h1>Basic SBV interface</h1>
<p>Some new interfaces:</p>
<pre><code>class Boolean b where
  true :: b
  bnot :: b -&gt; b
  (&amp;&amp;&amp;) :: b -&gt; b -&gt; b
  ...

class EqSymbolic a where
  (.==) :: a -&gt; a -&gt; SBool
  (./=) :: a -&gt; a -&gt; SBool
  ...

class Mergeable a where
  select :: (SymWord b, Num b) =&gt; [a] -&gt; a -&gt; SBV b -&gt; a
  ...

ite :: Mergeable a =&gt; SBool -&gt; a -&gt; a -&gt; a</code></pre>
</div>
<div id="basic-sbv-interface-2" class="slide section level1">
<h1>Basic SBV interface</h1>
<p>Symbolic reasoning type:</p>
<pre><code>data Symbolic a

instance Functor Symbolic
instance Applicative Symbolic
instance Monad Symbolic</code></pre>
<p>Introducing symbolic variables:</p>
<pre><code>sDouble :: String -&gt; Symbolic (SBV Double)
sBools :: [String] -&gt; Symbolic [SBV Bool]</code></pre>
<p>Constraints:</p>
<pre><code>constrain :: SBool -&gt; Symbolic ()</code></pre>
</div>
<div id="proof-of-associative-property-of-addition" class="slide section level1">
<h1>Proof of associative property of addition</h1>
<pre><code>additionAssoc x y z = (x + y) + z .== x + (y + z)</code></pre>
</div>
<div id="proof-of-associative-property-of-addition-1" class="slide section level1">
<h1>Proof of associative property of addition</h1>
<pre><code>additionAssoc x y z = (x + y) + z .== x + (y + z)

prove $ do
  [x, y, z] &lt;- sDoubles (pure &lt;$&gt; &quot;xyz&quot;)
  pure $ additionAssoc x y z</code></pre>
</div>
<div id="proof-of-associative-property-of-addition-2" class="slide section level1">
<h1>Proof of associative property of addition</h1>
<pre><code>additionAssoc x y z = (x + y) + z .== x + (y + z)

prove $ do
  [x, y, z] &lt;- sDoubles (pure &lt;$&gt; &quot;xyz&quot;)
  pure $ additionAssoc x y z</code></pre>
<!--  -->
<pre><code>Falsifiable. Counter-example:
  x =               Infinity :: Double
  y =              -Infinity :: Double
  z = -1.78607059478183e-310 :: Double</code></pre>
<!-- Ah yes -- `Infinity * (-Infinity)` is not a number (`NaN`), which is -->
<!-- not even equal to itself.  What a minefield! -->
</div>
<div id="proof-of-associative-property-of-addition-take-2" class="slide section level1">
<h1>Proof of associative property of addition (take 2)</h1>
<pre><code>prove $ do
  numbers@[x, y, z] &lt;- sDoubles (pure &lt;$&gt; &quot;xyz&quot;)
  constrain $ foldr (\n s -&gt; fpIsPoint n &amp;&amp;&amp; s) true numbers
  pure $ additionAssoc x y z</code></pre>
</div>
<div id="proof-of-associative-property-of-addition-take-2-1" class="slide section level1">
<h1>Proof of associative property of addition (take 2)</h1>
<pre><code>prove $ do
  numbers@[x, y, z] &lt;- sDoubles (pure &lt;$&gt; &quot;xyz&quot;)
  constrain $ foldr (\n s -&gt; fpIsPoint n &amp;&amp;&amp; s) true numbers
  pure $ additionAssoc x y z</code></pre>
<!--  -->
<pre><code>Falsifiable. Counter-example:
  x = -4.4479747933244543e-308 :: Double
  y =   3.785766995733679e-270 :: Double
  z =  -3.785766995733679e-270 :: Double</code></pre>
<!-- Wait, what? -->
</div>
<div id="are-ieee754-numbers-associative-under-addition" class="slide section level1">
<h1>Are IEEE754 numbers associative under addition?</h1>
<pre><code>&gt; (x + y)
3.785766995733679e-270
&gt; (x + y) + z
0.0
&gt; y + z
0.0
&gt; x + (y + z)
-4.4479747933244543e-308</code></pre>
<!-- Doesn't look like it. -->
</div>
<div id="how-about-integers" class="slide section level1">
<h1>How about integers?</h1>
<pre><code>prove $ do
  [x, y, z] &lt;- sIntegers (pure &lt;$&gt; &quot;xyz&quot;)
  pure $ additionAssoc x y z</code></pre>
</div>
<div id="how-about-integers-1" class="slide section level1">
<h1>How about integers?</h1>
<pre><code>prove $ do
  [x, y, z] &lt;- sIntegers (pure &lt;$&gt; &quot;xyz&quot;)
  pure $ additionAssoc x y z</code></pre>
<!--  -->
<pre><code>Q.E.D.</code></pre>
<!-- At least that part makes sense. -->
</div>
<div id="other-proofs" class="slide section level1">
<h1>Other proofs</h1>
<p>Please check out the SBV documentation for additional cool things to prove, including:</p>
<ul>
<li>correctness of <code>mergeSort</code></li>
<li>correctness of a bit-hacky assembly algorithm for integer multiplication
<ul>
<li>this proof includes a formalization of the archaic architecture for which the clever algorithm was first written</li>
</ul></li>
<li>correctness of a parallel algorithm for <code>scanl1</code></li>
</ul>
</div>
<div id="a-much-more-interesting-proof" class="slide section level1">
<h1>A much more interesting proof</h1>
<!-- Let's dig into a much more complicated proof.  One of the things I -->
<!-- want to emphasize about SMT solving is that many statements that I -->
<!-- don't know how to even begin to prove using Haskell or Coq are -->
<!-- amenable to proof by SMT solver.  As an engineer who works on -->
<!-- stability control systems, I often find I'd like to prove statements -->
<!-- that involve arithmetic, algebra and calculus, which is not a domain -->
<!-- that type systems like Haskell's are geared towards.  The example I'm -->
<!-- about to give comes from the theory of dynamical systems and has -->
<!-- nothing to do with induction, recursion, type checking, algebraic data -->
<!-- types or any such familiar concepts. -->
<p>Proof that a feedback controller stabilizes a physical system, just by stating the theorem and applying an SMT solver.</p>
</div>
<div id="a-much-more-interesting-proof-1" class="slide section level1">
<h1>A much more interesting proof</h1>
<p>Proof that a feedback controller stabilizes a physical system, just by stating the theorem and applying an SMT solver.</p>
<p>Assumptions:</p>
<ul>
<li>our model of the physical system captures all the relevant behavior</li>
<li>we know the relevant model parameters</li>
<li>we can directly measure the system’s state</li>
</ul>
<!-- The last of these is never true, but actually there are some useful -->
<!-- theorems that mean you can usually pretend it's true. -->
</div>
<div id="a-much-more-interesting-proof-2" class="slide section level1">
<h1>A much more interesting proof</h1>
<p>Proof that a feedback controller stabilizes a physical system, just by stating the theorem and applying an SMT solver.</p>
<p>Assumptions:</p>
<ul>
<li>our model of the physical system captures all the relevant behavior</li>
<li>we know the relevant model parameters</li>
<li>we can directly measure the system’s state</li>
</ul>
<p>Strategy:</p>
<ul>
<li>Examine the dynamics of the system
<ul>
<li>Translate dynamics into Haskell</li>
</ul></li>
<li>Change the system’s dynamics with feedback control
<ul>
<li>Translate the controller into Haskell</li>
</ul></li>
<li>Introduce Lyapunov’s direct method for proving stability
<ul>
<li>Translate the relevant theorem into Haskell</li>
</ul></li>
<li>Hook these parts up to SBV</li>
</ul>
</div>
<div id="a-much-more-interesting-proof-3" class="slide section level1">
<h1>A much more interesting proof</h1>
<p>Proof that a feedback controller stabilizes a physical system, just by stating the theorem and applying an SMT solver.</p>
<p>Assumptions:</p>
<ul>
<li>our model of the physical system captures all the relevant behavior</li>
<li>we know the relevant model parameters</li>
<li>we can directly measure the system’s state</li>
</ul>
<p>Strategy:</p>
<ul>
<li>Examine the dynamics of the system
<ul>
<li>Translate dynamics into Haskell</li>
</ul></li>
<li>Change the system’s dynamics with feedback control
<ul>
<li>Translate the controller into Haskell</li>
</ul></li>
<li>Introduce Lyapunov’s direct method for proving stability
<ul>
<li>Translate the relevant theorem into Haskell</li>
</ul></li>
<li>Hook these parts up to SBV</li>
<li>???</li>
<li>Pro(o)fit!</li>
</ul>
</div>
<div id="the-inverted-pendulum" class="slide section level1">
<h1>The inverted pendulum</h1>
<p><img src="pendulum-diagram.svg" title="Inverted pendulum diagram" /></p>
</div>
<div id="the-inverted-pendulum-1" class="slide section level1">
<h1>The inverted pendulum</h1>
<!-- All control engineers are required to understand this system -->
<!-- intimately.  It's a standard simple example in nonlinear control. -->
<p>Here are the dynamics of the pendulum, written as a differential equation:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
</div>
<div id="the-inverted-pendulum-2" class="slide section level1">
<h1>The inverted pendulum</h1>
<p>Here are the dynamics of the pendulum, written as a differential equation:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta" alt="\Huge \theta" title="\Huge \theta" /> - angle</li>
</ul>
<!-- the angle away from vertically up (rightwards / "in") -->
</div>
<div id="the-inverted-pendulum-3" class="slide section level1">
<h1>The inverted pendulum</h1>
<p>Here are the dynamics of the pendulum, written as a differential equation:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta" alt="\Huge \theta" title="\Huge \theta" /> - angle</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega" alt="\Huge \omega" title="\Huge \omega" /> - velocity</li>
</ul>
<!-- the rotational velocity of the pendulum (rightwards, or "in") -->
</div>
<div id="the-inverted-pendulum-4" class="slide section level1">
<h1>The inverted pendulum</h1>
<p>Here are the dynamics of the pendulum, written as a differential equation:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta" alt="\Huge \theta" title="\Huge \theta" /> - angle</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega" alt="\Huge \omega" title="\Huge \omega" /> - velocity</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Calpha" alt="\Huge \alpha" title="\Huge \alpha" /> - acceleration</li>
</ul>
<!-- the angular acceleration of the pendulum (rightwards, or "in") -->
</div>
<div id="the-inverted-pendulum-5" class="slide section level1">
<h1>The inverted pendulum</h1>
<p>Here are the dynamics of the pendulum, written as a differential equation:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta" alt="\Huge \theta" title="\Huge \theta" /> - angle</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega" alt="\Huge \omega" title="\Huge \omega" /> - velocity</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Calpha" alt="\Huge \alpha" title="\Huge \alpha" /> - acceleration</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> - torque</li>
</ul>
<!-- torque input using the motor -->
</div>
<div id="the-inverted-pendulum-6" class="slide section level1">
<h1>The inverted pendulum</h1>
<p>Here are the dynamics of the pendulum, written as a differential equation:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta" alt="\Huge \theta" title="\Huge \theta" /> - angle</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega" alt="\Huge \omega" title="\Huge \omega" /> - velocity</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Calpha" alt="\Huge \alpha" title="\Huge \alpha" /> - acceleration</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> - torque</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20b" alt="\Huge b" title="\Huge b" /> - damping coefficient</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20m" alt="\Huge m" title="\Huge m" /> - mass at the tip</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20l" alt="\Huge l" title="\Huge l" /> - length of arm</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20g" alt="\Huge g" title="\Huge g" /> - gravitational constant</li>
</ul>
<!-- This is just Newton's law of motion ($\Huge F = ma$) for a rotational -->
<!-- system.  If you want to know more about how to construct this equation -->
<!-- from the basic principles of mechanics, come see me after class; for -->
<!-- now, we'll move on. -->
</div>
<div id="the-inverted-pendulum-7" class="slide section level1">
<h1>The inverted pendulum</h1>
<p>Here are the dynamics of the pendulum, written as a differential equation:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta" alt="\Huge \theta" title="\Huge \theta" /> - angle</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega" alt="\Huge \omega" title="\Huge \omega" /> - velocity</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Calpha" alt="\Huge \alpha" title="\Huge \alpha" /> - acceleration</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> - torque</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20b" alt="\Huge b" title="\Huge b" /> - damping coefficient</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20m" alt="\Huge m" title="\Huge m" /> - mass at the tip</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20l" alt="\Huge l" title="\Huge l" /> - length of arm</li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20g" alt="\Huge g" title="\Huge g" /> - gravitational constant</li>
</ul>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega%20%3D%20%5Cfrac%7Bd%7D%7Bdt%7D%20%5Ctheta" alt="\Huge \omega = \frac{d}{dt} \theta" title="\Huge \omega = \frac{d}{dt} \theta" /></p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Calpha%20%3D%20%5Cfrac%7Bd%7D%7Bdt%7D%20%5Comega" alt="\Huge \alpha = \frac{d}{dt} \omega" title="\Huge \alpha = \frac{d}{dt} \omega" /></p>
</div>
<div id="the-inverted-pendulum-data-types" class="slide section level1">
<h1>The inverted pendulum (data types)</h1>
<pre><code>data Pendulum a = Pendulum
  { pendulumLength          :: a
  , pendulumDampingConstant :: a
  , pendulumMass            :: a
  , pendulumGravity         :: a
  } deriving (Eq, Show, Functor, Foldable, Traversable)

data State a = State
  { stateθ :: a
  , stateω :: a
  } deriving (Eq, Show, Functor, Foldable, Traversable)

newtype Controller a = Controller
  { controllerDamping :: a
  } deriving (Eq, Show, Functor, Foldable, Traversable)</code></pre>
</div>
<div id="the-inverted-pendulum-implementing-the-dynamics" class="slide section level1">
<h1>The inverted pendulum (implementing the dynamics)</h1>
<pre><code>pendulumInertia :: Fractional a =&gt; Pendulum a -&gt; a
pendulumInertia (Pendulum l _ m _) = m * l * l</code></pre>
</div>
<div id="the-inverted-pendulum-implementing-the-dynamics-1" class="slide section level1">
<h1>The inverted pendulum (implementing the dynamics)</h1>
<pre><code>pendulumInertia :: Fractional a =&gt; Pendulum a -&gt; a
pendulumInertia (Pendulum l _ m _) = m * l * l</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
</div>
<div id="the-inverted-pendulum-implementing-the-dynamics-2" class="slide section level1">
<h1>The inverted pendulum (implementing the dynamics)</h1>
<pre><code>pendulumInertia :: Fractional a =&gt; Pendulum a -&gt; a
pendulumInertia (Pendulum l _ m _) = m * l * l</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7Bd%7D%7Bdt%7D%5Cbegin%7Bbmatrix%7D%5Ctheta%20%5C%5C%20%5Comega%5Cend%7Bbmatrix%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%20%5Comega%20%5C%5C%20%5Cfrac%7Bb%7D%7Bml%5E2%7D%5Comega%20%2B%20%5Cfrac%7Bg%7D%7Bl%7D%20%5Csin%20%5Ctheta%20%2B%20%5Cfrac%7B1%7D%7Bml%5E2%7D%5Ctau%5Cend%7Bbmatrix%7D" alt="\Huge \frac{d}{dt}\begin{bmatrix}\theta \\ \omega\end{bmatrix} = \begin{bmatrix} \omega \\ \frac{b}{ml^2}\omega + \frac{g}{l} \sin \theta + \frac{1}{ml^2}\tau\end{bmatrix}" title="\Huge \frac{d}{dt}\begin{bmatrix}\theta \\ \omega\end{bmatrix} = \begin{bmatrix} \omega \\ \frac{b}{ml^2}\omega + \frac{g}{l} \sin \theta + \frac{1}{ml^2}\tau\end{bmatrix}" /></p>
</div>
<div id="the-inverted-pendulum-implementing-the-dynamics-3" class="slide section level1">
<h1>The inverted pendulum (implementing the dynamics)</h1>
<pre><code>pendulumInertia :: Fractional a =&gt; Pendulum a -&gt; a
pendulumInertia (Pendulum l _ m _) = m * l * l</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7Bd%7D%7Bdt%7D%5Cbegin%7Bbmatrix%7D%5Ctheta%20%5C%5C%20%5Comega%5Cend%7Bbmatrix%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%20%5Comega%20%5C%5C%20%5Cfrac%7Bb%7D%7Bml%5E2%7D%5Comega%20%2B%20%5Cfrac%7Bg%7D%7Bl%7D%20%5Csin%20%5Ctheta%20%2B%20%5Cfrac%7B1%7D%7Bml%5E2%7D%5Ctau%5Cend%7Bbmatrix%7D" alt="\Huge \frac{d}{dt}\begin{bmatrix}\theta \\ \omega\end{bmatrix} = \begin{bmatrix} \omega \\ \frac{b}{ml^2}\omega + \frac{g}{l} \sin \theta + \frac{1}{ml^2}\tau\end{bmatrix}" title="\Huge \frac{d}{dt}\begin{bmatrix}\theta \\ \omega\end{bmatrix} = \begin{bmatrix} \omega \\ \frac{b}{ml^2}\omega + \frac{g}{l} \sin \theta + \frac{1}{ml^2}\tau\end{bmatrix}" /></p>
<pre><code>pendulum :: Fractional a
         =&gt; Pendulum a  -- ^ System specification
         -&gt; a           -- ^ Input torque
         -&gt; State a     -- ^ Current state vector
         -&gt; State a     -- ^ Time-derivative of state vector
pendulum sys@(Pendulum l b _ g) τ (State θ ω) =
  State ω $
  (g * taylorSin θ) / l + (b * ω) / inertia + τ / inertia
  where
    inertia = pendulumInertia sys</code></pre>
<!-- but we define it over the whole state vector, so the time-derivative -->
<!-- of $\Huge \theta$ is just $\Huge \omega$. -->
</div>
<div id="the-inverted-pendulum-simulation-results-angle" class="slide section level1">
<h1>The inverted pendulum (simulation results – angle)</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28%5Ctheta%2C%20%5Comega%5Cright%29%20%5Cin%20%5Cbegin%7Bbmatrix%7D%2810%5E%7B-3%7D%2C%2010%5E%7B-3%7D%29%2C%20%26%20%28-0.5%2C%200.1%29%2C%20%26%20%280.3%2C%200.3%29%5Cend%7Bbmatrix%7D" alt="\Huge \left(\theta, \omega\right) \in \begin{bmatrix}(10^{-3}, 10^{-3}), &amp; (-0.5, 0.1), &amp; (0.3, 0.3)\end{bmatrix}" title="\Huge \left(\theta, \omega\right) \in \begin{bmatrix}(10^{-3}, 10^{-3}), &amp; (-0.5, 0.1), &amp; (0.3, 0.3)\end{bmatrix}" /> <!-- Here's what happens if we start the pendulum at $\Huge \theta = -1.1$ --> <!-- radians and $\Huge \omega = -0.3$ radians per second: --></p>
<p><img src="Unstabilized_theta.png" title="Unstabilized pendulum angle" /></p>
</div>
<div id="the-inverted-pendulum-simulation-results-velocity" class="slide section level1">
<h1>The inverted pendulum (simulation results – velocity)</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28%5Ctheta%2C%20%5Comega%5Cright%29%20%5Cin%20%5Cbegin%7Bbmatrix%7D%2810%5E%7B-3%7D%2C%2010%5E%7B-3%7D%29%2C%20%26%20%28-0.5%2C%200.1%29%2C%20%26%20%280.3%2C%200.3%29%5Cend%7Bbmatrix%7D" alt="\Huge \left(\theta, \omega\right) \in \begin{bmatrix}(10^{-3}, 10^{-3}), &amp; (-0.5, 0.1), &amp; (0.3, 0.3)\end{bmatrix}" title="\Huge \left(\theta, \omega\right) \in \begin{bmatrix}(10^{-3}, 10^{-3}), &amp; (-0.5, 0.1), &amp; (0.3, 0.3)\end{bmatrix}" /> <!-- Here's what happens if we start the pendulum at $\Huge \theta = -1.1$ --> <!-- radians and $\Huge \omega = -0.3$ radians per second: --></p>
<p><img src="Unstabilized_omega.png" title="Unstabilized pendulum velocity" /></p>
</div>
<div id="controlling-the-pendulum" class="slide section level1">
<h1>Controlling the pendulum</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
</div>
<div id="controlling-the-pendulum-1" class="slide section level1">
<h1>Controlling the pendulum</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p>Feedback control: specify input torque <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /></p>
</div>
<div id="controlling-the-pendulum-2" class="slide section level1">
<h1>Controlling the pendulum</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p>Feedback control: specify input torque <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> as a function of the state</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%5Ctheta%20%26%20%5Comega%20%5Cend%7Bbmatrix%7D%5E%7BT%7D" alt="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T}" title="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T}" /></p>
</div>
<div id="controlling-the-pendulum-3" class="slide section level1">
<h1>Controlling the pendulum</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p>Feedback control: specify input torque <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> as a function of the state</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%5Ctheta%20%26%20%5Comega%20%5Cend%7Bbmatrix%7D%5E%7BT%7D%20%5Csim" alt="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim" title="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim" /> <code>State a</code>.</p>
</div>
<div id="controlling-the-pendulum-4" class="slide section level1">
<h1>Controlling the pendulum</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p>Feedback control: specify input torque <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> as a function of the state</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%5Ctheta%20%26%20%5Comega%20%5Cend%7Bbmatrix%7D%5E%7BT%7D%20%5Csim%20~" alt="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim ~" title="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim ~" /> <code>State a</code>.</p>
<p>Goals:</p>
<ul>
<li>The pendulum should point straight up (<img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta%20%3D%200" alt="\Huge \theta = 0" title="\Huge \theta = 0" />).</li>
</ul>
</div>
<div id="controlling-the-pendulum-5" class="slide section level1">
<h1>Controlling the pendulum</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p>Feedback control: specify input torque <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> as a function of the state</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%5Ctheta%20%26%20%5Comega%20%5Cend%7Bbmatrix%7D%5E%7BT%7D%20%5Csim%20~" alt="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim ~" title="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim ~" /> <code>State a</code>.</p>
<p>Goals:</p>
<ul>
<li>The pendulum should point straight up (<img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta%20%3D%200" alt="\Huge \theta = 0" title="\Huge \theta = 0" />).</li>
<li>The pendulum shouldn’t be moving (<img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega%20%3D%200" alt="\Huge \omega = 0" title="\Huge \omega = 0" />).</li>
</ul>
</div>
<div id="controlling-the-pendulum-6" class="slide section level1">
<h1>Controlling the pendulum</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p>Feedback control: specify input torque <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> as a function of the state</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%5Ctheta%20%26%20%5Comega%20%5Cend%7Bbmatrix%7D%5E%7BT%7D%20%5Csim%20~" alt="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim ~" title="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim ~" /> <code>State a</code>.</p>
<p>Goals:</p>
<ul>
<li>The pendulum should point straight up (<img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta%20%3D%200" alt="\Huge \theta = 0" title="\Huge \theta = 0" />).</li>
<li>The pendulum shouldn’t be moving (<img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega%20%3D%200" alt="\Huge \omega = 0" title="\Huge \omega = 0" />).</li>
<li>No matter where you start it out or push it, it should eventually return to this state.</li>
</ul>
</div>
<div id="controlling-the-pendulum-7" class="slide section level1">
<h1>Controlling the pendulum</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20ml%5E2%5Calpha%20%3D%20b%5Comega%20%2B%20mgl%20%5Csin%20%5Ctheta%20%2B%20%5Ctau" alt="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" title="\Huge ml^2\alpha = b\omega + mgl \sin \theta + \tau" /></p>
<p>Feedback control: specify input torque <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau" alt="\Huge \tau" title="\Huge \tau" /> as a function of the state</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%5Ctheta%20%26%20%5Comega%20%5Cend%7Bbmatrix%7D%5E%7BT%7D%20%5Csim%20~" alt="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim ~" title="\Huge \vec{x} = \begin{bmatrix}\theta &amp; \omega \end{bmatrix}^{T} \sim ~" /> <code>State a</code>.</p>
<p>Goals:</p>
<ul>
<li>The pendulum should point straight up (<img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctheta%20%3D%200" alt="\Huge \theta = 0" title="\Huge \theta = 0" />).</li>
<li>The pendulum shouldn’t be moving (<img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Comega%20%3D%200" alt="\Huge \omega = 0" title="\Huge \omega = 0" />).</li>
<li>No matter where you start it out or push it, it should eventually return to this state.</li>
<li>Less wobbly would be nice.</li>
</ul>
</div>
<div id="controlling-the-pendulum-the-control-law" class="slide section level1">
<h1>Controlling the pendulum (the control law)</h1>
<!-- Control law design is a whole field of study (ask me more, I'll talk -->
<!-- till your ears bleed), but for this system, we can easily find a -->
<!-- simple physically motivated control law that will (provably) balance -->
<!-- the pendulum: -->
<p>Proposed feedback law:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau%20%3D%20-2mgl%20%5Csin%20%5Ctheta%20-%20k_%7Bd%7D%20%5Comega" alt="\Huge \tau = -2mgl \sin \theta - k_{d} \omega" title="\Huge \tau = -2mgl \sin \theta - k_{d} \omega" /></p>
<p>There are two parts:</p>
<ul>
<li><p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20-2mgl%20%5Csin%20%5Ctheta" alt="\Huge -2mgl \sin \theta" title="\Huge -2mgl \sin \theta" /> <!-- cancels out gravity (which is $\Huge mgl \sin \theta$) --> <!--    and then adds a "negative gravity" behavior on top. --></p></li>
<li><p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20-k_%7Bd%7D%20%5Comega" alt="\Huge -k_{d} \omega" title="\Huge -k_{d} \omega" /> <!-- adds some "damping" behavior -- we --> <!--    always command some torque that fights our current angular --> <!--    velocity. --></p></li>
</ul>
</div>
<div id="controlling-the-pendulum-the-control-law-1" class="slide section level1">
<h1>Controlling the pendulum (the control law)</h1>
<p>Proposed feedback law:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau%20%3D%20-2mgl%20%5Csin%20%5Ctheta%20-%20k_%7Bd%7D%20%5Comega" alt="\Huge \tau = -2mgl \sin \theta - k_{d} \omega" title="\Huge \tau = -2mgl \sin \theta - k_{d} \omega" /></p>
<p>There are two parts:</p>
<ul>
<li><p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20-2mgl%20%5Csin%20%5Ctheta" alt="\Huge -2mgl \sin \theta" title="\Huge -2mgl \sin \theta" /></p></li>
<li><p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20-k_%7Bd%7D%20%5Comega" alt="\Huge -k_{d} \omega" title="\Huge -k_{d} \omega" /></p></li>
</ul>
<p>In Haskell:</p>
<pre><code>runController :: Fractional a =&gt; Controller a -&gt; Pendulum a -&gt; State a -&gt; a
runController (Controller kd) (Pendulum l _ m g) (State θ ω) =
  (-2) * m * g * l * taylorSin θ - kd * ω</code></pre>
</div>
<div id="controlling-the-pendulum-the-control-law-2" class="slide section level1">
<h1>Controlling the pendulum (the control law)</h1>
<p>Proposed feedback law:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Ctau%20%3D%20-2mgl%20%5Csin%20%5Ctheta%20-%20k_%7Bd%7D%20%5Comega" alt="\Huge \tau = -2mgl \sin \theta - k_{d} \omega" title="\Huge \tau = -2mgl \sin \theta - k_{d} \omega" /></p>
<p>There are two parts:</p>
<ul>
<li><p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20-2mgl%20%5Csin%20%5Ctheta" alt="\Huge -2mgl \sin \theta" title="\Huge -2mgl \sin \theta" /></p></li>
<li><p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20-k_%7Bd%7D%20%5Comega" alt="\Huge -k_{d} \omega" title="\Huge -k_{d} \omega" /></p></li>
</ul>
<p>In Haskell:</p>
<pre><code>runController :: Fractional a =&gt; Controller a -&gt; Pendulum a -&gt; State a -&gt; a
runController (Controller kd) (Pendulum l _ m g) (State θ ω) =
  (-2) * m * g * l * taylorSin θ - kd * ω</code></pre>
<!-- To prove stability, of course we need to examine the pendulum while -->
<!-- it's under feedback control.  In control engineering, feedback control -->
<!-- is also referred to as "closing the [feedback] loop," so a -->
<!-- "closed-loop" system means a system exhibiting both the natural -->
<!-- dynamics and the controller combined.  This is easy: -->
<pre><code>closedLoop ::
  Fractional a =&gt; Controller a -&gt; Pendulum a -&gt; State a -&gt; State a
closedLoop ctrl system initialState =
  pendulum system torque initialState
  where
    torque = runController ctrl system initialState</code></pre>
</div>
<div id="controlling-the-pendulum-simulation-results-angle" class="slide section level1">
<h1>Controlling the pendulum (simulation results – angle)</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28%5Ctheta%2C%20%5Comega%5Cright%29%20%5Cin%20%5Cbegin%7Bbmatrix%7D%2810%5E%7B-3%7D%2C%2010%5E%7B-3%7D%29%2C%20%26%20%28-0.5%2C%200.1%29%2C%20%26%20%280.3%2C%200.3%29%5Cend%7Bbmatrix%7D" alt="\Huge \left(\theta, \omega\right) \in \begin{bmatrix}(10^{-3}, 10^{-3}), &amp; (-0.5, 0.1), &amp; (0.3, 0.3)\end{bmatrix}" title="\Huge \left(\theta, \omega\right) \in \begin{bmatrix}(10^{-3}, 10^{-3}), &amp; (-0.5, 0.1), &amp; (0.3, 0.3)\end{bmatrix}" /></p>
<!-- Recall that without a feedback control law, the pendulum just swung -->
<!-- down and oscillated, slowly settling towards $\Huge \theta = -\pi$ -->
<!-- (straight down) and $\Huge \omega = 0$ (no movement).   -->
<!-- Let's simulate -->
<!-- the same system with the feedback controller we've just proved should -->
<!-- stabilize it for any initial state from the same initial state as -->
<!-- before, just as a way to sanity-check what we've just written.  We -->
<!-- expect it to rise to pointing straight up and stay put: -->
<p><img src="Stabilized_theta.png" title="Stabilized pendulum angle" /></p>
<!-- and it does. -->
</div>
<div id="controlling-the-pendulum-simulation-results-velocity" class="slide section level1">
<h1>Controlling the pendulum (simulation results – velocity)</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28%5Ctheta%2C%20%5Comega%5Cright%29%20%5Cin%20%5Cbegin%7Bbmatrix%7D%2810%5E%7B-3%7D%2C%2010%5E%7B-3%7D%29%2C%20%26%20%28-0.5%2C%200.1%29%2C%20%26%20%280.3%2C%200.3%29%5Cend%7Bbmatrix%7D" alt="\Huge \left(\theta, \omega\right) \in \begin{bmatrix}(10^{-3}, 10^{-3}), &amp; (-0.5, 0.1), &amp; (0.3, 0.3)\end{bmatrix}" title="\Huge \left(\theta, \omega\right) \in \begin{bmatrix}(10^{-3}, 10^{-3}), &amp; (-0.5, 0.1), &amp; (0.3, 0.3)\end{bmatrix}" /></p>
<p><img src="Stabilized_omega.png" title="Stabilized pendulum velocity" /></p>
</div>
<div id="lyapunovs-direct-method" class="slide section level1">
<h1>Lyapunov’s direct method</h1>
<!-- This is one of the standard tools in control of nonlinear systems. -->
<!-- Briefly, if you can define a function $\Huge V(\vec{x})$ of the system -->
<!-- state that is zero at the equilibrium point, is positive everywhere -->
<!-- else and whose time derivative $\Huge \frac{d}{dt}V(\vec{x})$ is negative or -->
<!-- zero everywhere, then the system is stable.  The conditions: -->
<p>One of several theorems by Lyapunov:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cforall%20V%20%5Cin%20%5Cmathbb%7BR%7D%5E%7Bn%7D%20%5Cto%20%5Cmathbb%7BR%7D" alt="\Huge \forall V \in \mathbb{R}^{n} \to \mathbb{R}" title="\Huge \forall V \in \mathbb{R}^{n} \to \mathbb{R}" /></p>
<pre><code>v :: Fractional a =&gt; State a -&gt; a</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%5Csim" alt="\Huge \vec{x} \sim" title="\Huge \vec{x} \sim" /> <code>State a</code></p>
</div>
<div id="lyapunovs-direct-method-1" class="slide section level1">
<h1>Lyapunov’s direct method</h1>
<p>One of several theorems by Lyapunov:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cforall%20V%20%5Cin%20%5Cmathbb%7BR%7D%5E%7Bn%7D%20%5Cto%20%5Cmathbb%7BR%7D" alt="\Huge \forall V \in \mathbb{R}^{n} \to \mathbb{R}" title="\Huge \forall V \in \mathbb{R}^{n} \to \mathbb{R}" /></p>
<pre><code>v :: Fractional a =&gt; State a -&gt; a</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%5Csim" alt="\Huge \vec{x} \sim" title="\Huge \vec{x} \sim" /> <code>State a</code></p>
<p>If</p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%7B0%7D%29%20%3D%200" alt="\Huge V({0}) = 0" title="\Huge V({0}) = 0" /></li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%5Cleft%28%5Cvec%7Bx%7D%5Cright%29%20%3E%200%2C%20%5Cvec%7Bx%7D%20%5Cneq%20%5Cvec%7B0%7D" alt="\Huge V\left(\vec{x}\right) &gt; 0, \vec{x} \neq \vec{0}" title="\Huge V\left(\vec{x}\right) &gt; 0, \vec{x} \neq \vec{0}" /></li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7Bd%7D%7Bdt%7DV%5Cleft%28%5Cvec%7Bx%7D%5Cright%29%20%5Cleq%200" alt="\Huge \frac{d}{dt}V\left(\vec{x}\right) \leq 0" title="\Huge \frac{d}{dt}V\left(\vec{x}\right) \leq 0" /></li>
</ul>
<p>Then the system is stable at <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%200" alt="\Huge \vec{x} = 0" title="\Huge \vec{x} = 0" /></p>
</div>
<div id="lyapunovs-direct-method-2" class="slide section level1">
<h1>Lyapunov’s direct method</h1>
<p>One of several theorems by Lyapunov:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cforall%20V%20%5Cin%20%5Cmathbb%7BR%7D%5E%7Bn%7D%20%5Cto%20%5Cmathbb%7BR%7D" alt="\Huge \forall V \in \mathbb{R}^{n} \to \mathbb{R}" title="\Huge \forall V \in \mathbb{R}^{n} \to \mathbb{R}" /></p>
<pre><code>v :: Fractional a =&gt; State a -&gt; a</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%5Csim" alt="\Huge \vec{x} \sim" title="\Huge \vec{x} \sim" /> <code>State a</code></p>
<p>If</p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%7B0%7D%29%20%3D%200" alt="\Huge V({0}) = 0" title="\Huge V({0}) = 0" /></li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%5Cleft%28%5Cvec%7Bx%7D%5Cright%29%20%3E%200%2C%20%5Cvec%7Bx%7D%20%5Cneq%20%5Cvec%7B0%7D" alt="\Huge V\left(\vec{x}\right) &gt; 0, \vec{x} \neq \vec{0}" title="\Huge V\left(\vec{x}\right) &gt; 0, \vec{x} \neq \vec{0}" /></li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7Bd%7D%7Bdt%7DV%5Cleft%28%5Cvec%7Bx%7D%5Cright%29%20%5Cleq%200" alt="\Huge \frac{d}{dt}V\left(\vec{x}\right) \leq 0" title="\Huge \frac{d}{dt}V\left(\vec{x}\right) \leq 0" /></li>
</ul>
<p>Then the system is stable at <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%200" alt="\Huge \vec{x} = 0" title="\Huge \vec{x} = 0" /></p>
<blockquote>
<p>How can this prove stability if it doesn’t mention the system dynamics <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28%5Calpha%20%3D%20%5Ctexttt%7B%5Cldots%7D%5Cright%29" alt="\Huge \left(\alpha = \texttt{\ldots}\right)" title="\Huge \left(\alpha = \texttt{\ldots}\right)" />?</p>
</blockquote>
</div>
<div id="lyapunovs-direct-method-3" class="slide section level1">
<h1>Lyapunov’s direct method</h1>
<p>One of several theorems by Lyapunov:</p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cforall%20V%20%5Cin%20%5Cmathbb%7BR%7D%5E%7Bn%7D%20%5Cto%20%5Cmathbb%7BR%7D" alt="\Huge \forall V \in \mathbb{R}^{n} \to \mathbb{R}" title="\Huge \forall V \in \mathbb{R}^{n} \to \mathbb{R}" /></p>
<pre><code>v :: Fractional a =&gt; State a -&gt; a</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%5Csim" alt="\Huge \vec{x} \sim" title="\Huge \vec{x} \sim" /> <code>State a</code></p>
<p>If</p>
<ul>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%7B0%7D%29%20%3D%200" alt="\Huge V({0}) = 0" title="\Huge V({0}) = 0" /></li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%5Cleft%28%5Cvec%7Bx%7D%5Cright%29%20%3E%200%2C%20%5Cvec%7Bx%7D%20%5Cneq%20%5Cvec%7B0%7D" alt="\Huge V\left(\vec{x}\right) &gt; 0, \vec{x} \neq \vec{0}" title="\Huge V\left(\vec{x}\right) &gt; 0, \vec{x} \neq \vec{0}" /></li>
<li><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7Bd%7D%7Bdt%7DV%5Cleft%28%5Cvec%7Bx%7D%5Cright%29%20%5Cleq%200" alt="\Huge \frac{d}{dt}V\left(\vec{x}\right) \leq 0" title="\Huge \frac{d}{dt}V\left(\vec{x}\right) \leq 0" /></li>
</ul>
<p>Then the system is stable at <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cvec%7Bx%7D%20%3D%200" alt="\Huge \vec{x} = 0" title="\Huge \vec{x} = 0" /></p>
<blockquote>
<p>How can this prove stability if it doesn’t mention the system dynamics <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28%5Calpha%20%3D%20%5Ctexttt%7B%5Cldots%7D%5Cright%29" alt="\Huge \left(\alpha = \texttt{\ldots}\right)" title="\Huge \left(\alpha = \texttt{\ldots}\right)" />?</p>
</blockquote>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7Bd%7D%7Bdt%7D%5Cbegin%7Bbmatrix%7D%5Ctheta%20%5C%5C%20%5Comega%5Cend%7Bbmatrix%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%20%5Comega%20%5C%5C%20%5Cfrac%7Bb%7D%7Bml%5E2%7D%5Comega%20%2B%20%5Cfrac%7Bg%7D%7Bl%7D%20%5Csin%20%5Ctheta%20%2B%20%5Cfrac%7B1%7D%7Bml%5E2%7D%5Ctau%5Cend%7Bbmatrix%7D" alt="\Huge \frac{d}{dt}\begin{bmatrix}\theta \\ \omega\end{bmatrix} = \begin{bmatrix} \omega \\ \frac{b}{ml^2}\omega + \frac{g}{l} \sin \theta + \frac{1}{ml^2}\tau\end{bmatrix}" title="\Huge \frac{d}{dt}\begin{bmatrix}\theta \\ \omega\end{bmatrix} = \begin{bmatrix} \omega \\ \frac{b}{ml^2}\omega + \frac{g}{l} \sin \theta + \frac{1}{ml^2}\tau\end{bmatrix}" /></p>
<!-- When we compute $\Huge \frac{\partial V}{\partial t}$, the dynamics -->
<!-- will get brought into the theorem. -->
</div>
<div id="implementation-of-the-theorem-lyapunov-function" class="slide section level1">
<h1>Implementation of the theorem (Lyapunov function)</h1>
<!-- A good starting point for a Lyapunov function is to look at the total -->
<!-- energy in the system.  Intuitively, if you can prove that the total -->
<!-- energy always decreases, then _something_ is stabilizing. -->
<p>Kinetic energy: <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7B1%7D%7B2%7D%20ml%5E2%5Comega%5E2" alt="\Huge \frac{1}{2} ml^2\omega^2" title="\Huge \frac{1}{2} ml^2\omega^2" /></p>
<pre><code>kineticEnergy :: Fractional a =&gt; Pendulum a -&gt; State a -&gt; a
kineticEnergy system (State _ ω) =
  0.5 * pendulumInertia system * ω * ω</code></pre>
</div>
<div id="implementation-of-the-theorem-lyapunov-function-1" class="slide section level1">
<h1>Implementation of the theorem (Lyapunov function)</h1>
<p>Kinetic energy: <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7B1%7D%7B2%7D%20ml%5E2%5Comega%5E2" alt="\Huge \frac{1}{2} ml^2\omega^2" title="\Huge \frac{1}{2} ml^2\omega^2" /></p>
<pre><code>kineticEnergy :: Fractional a =&gt; Pendulum a -&gt; State a -&gt; a
kineticEnergy system (State _ ω) =
  0.5 * pendulumInertia system * ω * ω</code></pre>
<p>Potential energy: <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20mgl%20%5Cleft%28%5Ccos%20%5Ctheta%20-%201%5Cright%29" alt="\Huge mgl \left(\cos \theta - 1\right)" title="\Huge mgl \left(\cos \theta - 1\right)" /></p>
<pre><code>potentialEnergy :: Fractional a =&gt; Pendulum a -&gt; State a -&gt; a
potentialEnergy (Pendulum l _ m g) (State θ _) =
  m * g * l * (taylorCos θ - 1)</code></pre>
<p>spans <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20mgl%20%5Ccdot%20%5B-2%2C%200%5D" alt="\Huge mgl \cdot [-2, 0]" title="\Huge mgl \cdot [-2, 0]" /></p>
</div>
<div id="implementation-of-the-theorem-lyapunov-function-2" class="slide section level1">
<h1>Implementation of the theorem (Lyapunov function)</h1>
<p>Kinetic energy: <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cfrac%7B1%7D%7B2%7Dml%5E2%5Comega%5E2" alt="\Huge \frac{1}{2}ml^2\omega^2" title="\Huge \frac{1}{2}ml^2\omega^2" /></p>
<pre><code>kineticEnergy :: Fractional a =&gt; Pendulum a -&gt; State a -&gt; a
kineticEnergy system (State _ ω) =
  0.5 * pendulumInertia system * ω * ω</code></pre>
<p>Potential energy: <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20mgl%20%5Cleft%28%5Ccos%20%5Ctheta%20-%201%5Cright%29" alt="\Huge mgl \left(\cos \theta - 1\right)" title="\Huge mgl \left(\cos \theta - 1\right)" /></p>
<pre><code>potentialEnergy :: Fractional a =&gt; Pendulum a -&gt; State a -&gt; a
potentialEnergy (Pendulum l _ m g) (State θ _) =
  m * g * l * (taylorCos θ - 1)</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%5Cvec%7Bx%7D%29%20%3D%20T%20-%20U" alt="\Huge V(\vec{x}) = T - U" title="\Huge V(\vec{x}) = T - U" /> (so that <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%20%3E%200" alt="\Huge V &gt; 0" title="\Huge V &gt; 0" />)</p>
<pre><code>v :: Fractional a =&gt; Pendulum a -&gt; State a -&gt; a
v system st =
  kineticEnergy system st - potentialEnergy system st</code></pre>
<!-- Lyapunov function choice is not generally automatable; sometimes you -->
<!-- just can't find one.  I had a professor in college who searched for a -->
<!-- Lyapunov function for his controller for 6 years before giving up! -->
</div>
<div id="implementation-of-the-theorem-lyapunov-function-derivative" class="slide section level1">
<h1>Implementation of the theorem (Lyapunov function derivative)</h1>
<!-- Everything on this slide is just applying the rules of calculus and -->
<!-- writing it in Haskell. -->
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cbegin%7Bmatrix%7D%5Cfrac%7Bd%7D%7Bdt%7DV%28%5Cvec%7Bx%7D%29%20%26%3D%20%5Cfrac%7Bd%7D%7Bdt%7DT%20-%20%5Cfrac%7Bd%7D%7Bdt%7DU%20%5C%5C%20~%20%26%3D%20ml%5E2%20%5Ccdot%20%5Comega%20%5Ccdot%20%5Calpha%20%2B%20mgl%20%5Csin%5Ctheta%5Cend%7Bmatrix%7D" alt="\Huge \begin{matrix}\frac{d}{dt}V(\vec{x}) &amp;= \frac{d}{dt}T - \frac{d}{dt}U \\ ~ &amp;= ml^2 \cdot \omega \cdot \alpha + mgl \sin\theta\end{matrix}" title="\Huge \begin{matrix}\frac{d}{dt}V(\vec{x}) &amp;= \frac{d}{dt}T - \frac{d}{dt}U \\ ~ &amp;= ml^2 \cdot \omega \cdot \alpha + mgl \sin\theta\end{matrix}" /></p>
<pre><code>dkedt :: Fractional a =&gt;
  Controller a -&gt; Pendulum a -&gt; State a -&gt; a
dkedt ctrl system state@(State _ ω) =
  pendulumInertia system * ω * stateω (closedLoop ctrl system state)

dpedt :: Fractional a =&gt;
  Pendulum a -&gt; State a -&gt; a
dpedt (Pendulum l _ m g) (State θ ω) =
  m * g * l * (- taylorSin θ) * ω

dvdt :: Fractional a =&gt;
  Controller a -&gt; Pendulum a -&gt; State a -&gt; a
dvdt ctrl system st =
  dkedt ctrl system st - dpedt system st</code></pre>
<!-- Note that here is where we bring in the system dynamics, by calling -->
<!-- the `closedLoop` function. -->
</div>
<div id="implementation-of-the-theorem-proof-statement" class="slide section level1">
<h1>Implementation of the theorem (proof statement)</h1>
<pre><code>lyapunov&#39;sTheorem gen f dfdt = do
  st &lt;- traverse gen stateLabels
  constrainPi st




  where
    constrainPi (State θ _) = constrain $ θ .&lt;= π &amp;&amp;&amp; θ .&gt; -π
    π = 3.1415926535897932384626433832795028841971693993751</code></pre>
</div>
<div id="implementation-of-the-theorem-proof-statement-1" class="slide section level1">
<h1>Implementation of the theorem (proof statement)</h1>
<pre><code>lyapunov&#39;sTheorem gen f dfdt = do
  st &lt;- traverse gen stateLabels
  constrainPi st
  eq &lt;- lyapunovEquilibrium st



  where
    constrainPi (State θ _) = constrain $ θ .&lt;= π &amp;&amp;&amp; θ .&gt; -π
    π = 3.1415926535897932384626433832795028841971693993751</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%5Cvec%7B0%7D%29%20%3D%200" alt="\Huge V(\vec{0}) = 0" title="\Huge V(\vec{0}) = 0" /></p>
<pre><code>    lyapunovEquilibrium _ = pure $
      f (State 0 0) .== 0.0</code></pre>
</div>
<div id="implementation-of-the-theorem-proof-statement-2" class="slide section level1">
<h1>Implementation of the theorem (proof statement)</h1>
<pre><code>lyapunov&#39;sTheorem gen f dfdt = do
  st &lt;- traverse gen stateLabels
  constrainPi st
  eq &lt;- lyapunovEquilibrium st
  nn &lt;- lyapunovNonNegative st


  where
    constrainPi (State θ _) = constrain $ θ .&lt;= π &amp;&amp;&amp; θ .&gt; -π
    π = 3.1415926535897932384626433832795028841971693993751</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%5Cvec%7B0%7D%29%20%3D%200" alt="\Huge V(\vec{0}) = 0" title="\Huge V(\vec{0}) = 0" /></p>
<pre><code>    lyapunovEquilibrium _ = pure $
      f (State 0 0) .== 0.0</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%5Cvec%7Bx%7D%29%20%3E%200%2C%20%5Cvec%7Bx%7D%20%5Cneq%20%5Cvec%7B0%7D" alt="\Huge V(\vec{x}) &gt; 0, \vec{x} \neq \vec{0}" title="\Huge V(\vec{x}) &gt; 0, \vec{x} \neq \vec{0}" /></p>
<pre><code>    lyapunovNonNegative st = do
      constrain $ st ./= State 0 0
      pure $ f st .&gt; 0.0</code></pre>
</div>
<div id="implementation-of-the-theorem-proof-statement-3" class="slide section level1">
<h1>Implementation of the theorem (proof statement)</h1>
<pre><code>lyapunov&#39;sTheorem gen f dfdt = do
  st &lt;- traverse gen stateLabels
  constrainPi st
  eq &lt;- lyapunovEquilibrium st
  nn &lt;- lyapunovNonNegative st
  gn &lt;- lyapunovGradNegative st

  where
    constrainPi (State θ _) = constrain $ θ .&lt;= π &amp;&amp;&amp; θ .&gt; -π
    π = 3.1415926535897932384626433832795028841971693993751</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%5Cvec%7B0%7D%29%20%3D%200" alt="\Huge V(\vec{0}) = 0" title="\Huge V(\vec{0}) = 0" /></p>
<pre><code>    lyapunovEquilibrium _ = pure $
      f (State 0 0) .== 0.0</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%5Cvec%7Bx%7D%29%20%3E%200%2C%20%5Cvec%7Bx%7D%20%5Cneq%20%5Cvec%7B0%7D" alt="\Huge V(\vec{x}) &gt; 0, \vec{x} \neq \vec{0}" title="\Huge V(\vec{x}) &gt; 0, \vec{x} \neq \vec{0}" /></p>
<pre><code>    lyapunovNonNegative st = do
      constrain $ st ./= State 0 0
      pure $ f st .&gt; 0.0</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cdot%7BV%7D%28%5Cvec%7Bx%7D%29%20%3C%3D%200" alt="\Huge \dot{V}(\vec{x}) &lt;= 0" title="\Huge \dot{V}(\vec{x}) &lt;= 0" /></p>
<pre><code>    lyapunovGradNegative st = pure $
      dfdt st .&lt;= 0.0 &amp;&amp;&amp; dfdt (State 0 0) .&lt;= 0.0</code></pre>
</div>
<div id="implementation-of-the-theorem-proof-statement-4" class="slide section level1">
<h1>Implementation of the theorem (proof statement)</h1>
<pre><code>lyapunov&#39;sTheorem gen f dfdt = do
  st &lt;- traverse gen stateLabels
  constrainPi st
  eq &lt;- lyapunovEquilibrium st
  nn &lt;- lyapunovNonNegative st
  gn &lt;- lyapunovGradNegative st
  pure $ eq &amp;&amp;&amp; nn &amp;&amp;&amp; gn
  where
    constrainPi (State θ _) = constrain $ θ .&lt;= π &amp;&amp;&amp; θ .&gt; -π
    π = 3.1415926535897932384626433832795028841971693993751</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%5Cvec%7B0%7D%29%20%3D%200" alt="\Huge V(\vec{0}) = 0" title="\Huge V(\vec{0}) = 0" /></p>
<pre><code>    lyapunovEquilibrium _ = pure $
      f (State 0 0) .== 0.0</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20V%28%5Cvec%7Bx%7D%29%20%3E%200%2C%20%5Cvec%7Bx%7D%20%5Cneq%20%5Cvec%7B0%7D" alt="\Huge V(\vec{x}) &gt; 0, \vec{x} \neq \vec{0}" title="\Huge V(\vec{x}) &gt; 0, \vec{x} \neq \vec{0}" /></p>
<pre><code>    lyapunovNonNegative st = do
      constrain $ st ./= State 0 0
      pure $ f st .&gt; 0.0</code></pre>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cdot%7BV%7D%28%5Cvec%7Bx%7D%29%20%3C%3D%200" alt="\Huge \dot{V}(\vec{x}) &lt;= 0" title="\Huge \dot{V}(\vec{x}) &lt;= 0" /></p>
<pre><code>    lyapunovGradNegative st = pure $
      dfdt st .&lt;= 0.0 &amp;&amp;&amp; dfdt (State 0 0) .&lt;= 0.0</code></pre>
</div>
<div id="proving-lyapunovs-theorem-for-the-stabilized-pendulum" class="slide section level1">
<h1>Proving Lyapunov’s theorem for the stabilized pendulum</h1>
<pre><code>nominalController = Controller
  { controllerDamping = 0.3
  }

nominalSystem = Pendulum
  { pendulumLength = 0.5
  , pendulumDampingConstant = -0.03
  , pendulumMass = 0.1
  , pendulumGravity = 9.81
  }</code></pre>
</div>
<div id="proving-lyapunovs-theorem-for-the-stabilized-pendulum-1" class="slide section level1">
<h1>Proving Lyapunov’s theorem for the stabilized pendulum</h1>
<pre><code>nominalController = Controller
  { controllerDamping = 0.3
  }

nominalSystem = Pendulum
  { pendulumLength = 0.5
  , pendulumDampingConstant = -0.03
  , pendulumMass = 0.1
  , pendulumGravity = 9.81
  }

proveStability =
  prove $ lyapunov&#39;sTheorem sReal v&#39; dvdt&#39;
  where
    v&#39; = v nominalSystem
    dvdt&#39; = dvdt nominalController nominalSystem</code></pre>
</div>
<div id="proving-lyapunovs-theorem-for-the-stabilized-pendulum-2" class="slide section level1">
<h1>Proving Lyapunov’s theorem for the stabilized pendulum</h1>
<pre><code>nominalController = Controller
  { controllerDamping = 0.3
  }

nominalSystem = Pendulum
  { pendulumLength = 0.5
  , pendulumDampingConstant = -0.03
  , pendulumMass = 0.1
  , pendulumGravity = 9.81
  }

proveStability =
  prove $ lyapunov&#39;sTheorem sReal v&#39; dvdt&#39;
  where
    v&#39; = v nominalSystem
    dvdt&#39; = dvdt nominalController nominalSystem</code></pre>
<!--  -->
<pre><code>Pendulum&gt; proveStability</code></pre>
</div>
<div id="proving-lyapunovs-theorem-for-the-stabilized-pendulum-3" class="slide section level1">
<h1>Proving Lyapunov’s theorem for the stabilized pendulum</h1>
<pre><code>nominalController = Controller
  { controllerDamping = 0.3
  }

nominalSystem = Pendulum
  { pendulumLength = 0.5
  , pendulumDampingConstant = -0.03
  , pendulumMass = 0.1
  , pendulumGravity = 9.81
  }

proveStability =
  prove $ lyapunov&#39;sTheorem sReal v&#39; dvdt&#39;
  where
    v&#39; = v nominalSystem
    dvdt&#39; = dvdt nominalController nominalSystem</code></pre>
<!--  -->
<pre><code>Pendulum&gt; proveStability
Q.E.D.</code></pre>
<!-- Note that we did not have to provide any guidance as to _how_ to prove -->
<!-- this theorem.  The flip side of the coin is that we are at the mercy -->
<!-- of the SMT solver regarding how this gets proven, if at all. -->
<!-- Sometimes it just takes a really long time. -->
</div>
<div id="implementation-concerns" class="slide section level1">
<h1>Implementation concerns</h1>
<!-- You may have noticed some oddities in how this was implemented: -->
<ul>
<li><p><code>taylorSin</code> and <code>taylorCos</code> <!-- are due to SMTLIB not supporting --> <!--    trigonometric functions; instead I have implemented them by a --> <!--    Taylor series approximation. --></p></li>
<li><p><code>m * l * l</code> <!-- is due to SMTLIB not supporting exponentiation --> <!--    (e.g. `l**2`). --></p></li>
<li><p><code>π = 3.14159...</code> <!-- is due to SBV not implementing `pi` for --> <!--    the `Floating` class. --></p></li>
</ul>
</div>
<div id="further-implementation-considerations-floating-point-implementation" class="slide section level1">
<h1>Further implementation considerations (floating-point implementation)</h1>
<!-- Let's make sure that if we implement our controller in floating-point -->
<!-- arithmetic, it will never introduce a `NaN` or `Infinity` value. -->
<p>Next theorem: if the state vector we input to the control law <code>f</code></p>
<ul>
<li>contains no <code>NaN</code> or <code>Infinity</code> values</li>
<li>has been correctly wrapped to the interval <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28-%5Cpi%2C%20%5Cpi%5Cright%5D" alt="\Huge \left(-\pi, \pi\right]" title="\Huge \left(-\pi, \pi\right]" /></li>
</ul>
<p>then the output will also contain no <code>NaN</code> or <code>Infinity</code>.</p>
</div>
<div id="further-implementation-considerations-floating-point-implementation-1" class="slide section level1">
<h1>Further implementation considerations (floating-point implementation)</h1>
<p>Next theorem: if the state vector we input to the control law <code>f</code></p>
<ul>
<li>contains no <code>NaN</code> or <code>Infinity</code> values</li>
<li>has been correctly wrapped to the interval <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28-%5Cpi%2C%20%5Cpi%5Cright%5D" alt="\Huge \left(-\pi, \pi\right]" title="\Huge \left(-\pi, \pi\right]" /></li>
</ul>
<p>then the output will also contain no <code>NaN</code> or <code>Infinity</code>.</p>
<pre><code>nanFree f = do
  st &lt;- State &lt;$&gt; sFloat &quot;θ&quot; &lt;*&gt; sFloat &quot;ω&quot;
  constrainPi st
  constrainFP st
  pure . fpIsPoint $ f st
  where
    constrainPi (State θ _) = constrain $ θ .&lt;= π &amp;&amp;&amp; θ .&gt; -π
    π = 3.1415926535897932384626433832795028841971693993751

    constrainFP = constrain . allIsPoint</code></pre>
</div>
<div id="further-implementation-considerations-floating-point-implementation-2" class="slide section level1">
<h1>Further implementation considerations (floating-point implementation)</h1>
<p>Next theorem: if the state vector we input to the control law <code>f</code></p>
<ul>
<li>contains no <code>NaN</code> or <code>Infinity</code> values</li>
<li>has been correctly wrapped to the interval <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28-%5Cpi%2C%20%5Cpi%5Cright%5D" alt="\Huge \left(-\pi, \pi\right]" title="\Huge \left(-\pi, \pi\right]" /></li>
</ul>
<p>then the output will also contain no <code>NaN</code> or <code>Infinity</code>.</p>
<pre><code>nanFree f = do
  st &lt;- State &lt;$&gt; sFloat &quot;θ&quot; &lt;*&gt; sFloat &quot;ω&quot;
  constrainPi st
  constrainFP st
  pure . fpIsPoint $ f st
  where
    constrainPi (State θ _) = constrain $ θ .&lt;= π &amp;&amp;&amp; θ .&gt; -π
    π = 3.1415926535897932384626433832795028841971693993751

    constrainFP = constrain . allIsPoint</code></pre>
<!-- `proveNanSafety` just specifies `gen` (`sFloat`) and `f` (the -->
<!-- controller attached to the controller and system parameters): -->
<pre><code>Pendulum&gt; proveNanSafety</code></pre>
</div>
<div id="further-implementation-considerations-floating-point-implementation-3" class="slide section level1">
<h1>Further implementation considerations (floating-point implementation)</h1>
<p>Next theorem: if the state vector we input to the control law <code>f</code></p>
<ul>
<li>contains no <code>NaN</code> or <code>Infinity</code> values</li>
<li>has been correctly wrapped to the interval <img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cleft%28-%5Cpi%2C%20%5Cpi%5Cright%5D" alt="\Huge \left(-\pi, \pi\right]" title="\Huge \left(-\pi, \pi\right]" /></li>
</ul>
<p>then the output will also contain no <code>NaN</code> or <code>Infinity</code>.</p>
<pre><code>nanFree f = do
  st &lt;- State &lt;$&gt; sFloat &quot;θ&quot; &lt;*&gt; sFloat &quot;ω&quot;
  constrainPi st
  constrainFP st
  pure . fpIsPoint $ f st
  where
    constrainPi (State θ _) = constrain $ θ .&lt;= π &amp;&amp;&amp; θ .&gt; -π
    π = 3.1415926535897932384626433832795028841971693993751

    constrainFP = constrain . allIsPoint</code></pre>
<!-- `proveNanSafety` just specifies `gen` (`sFloat`) and `f` (the -->
<!-- controller attached to the controller and system parameters): -->
<pre><code>Pendulum&gt; proveNanSafety
Q.E.D.</code></pre>
<!-- This took all night on my laptop (for 32-bit floating-point).  In my -->
<!-- experience, MathSAT is often quite a bit faster than Z3 for -->
<!-- floating-point proofs, but I was lazy and just ran Z3. -->
</div>
<div id="real-implementation-considerations" class="slide section level1">
<h1>Real implementation considerations</h1>
<!-- One of the many reasons we often build DSLs in situations like this is -->
<!-- that it makes it straightforward to interpret our logic in multiple -->
<!-- ways.  SBV is no exception: without modifying our controller, we can -->
<!-- generate the (exact) equivalent C code. -->
<pre><code>emitController gen = compileToC Nothing &quot;runController&quot; $ do
  system &lt;- Pendulum
    &lt;$&gt; gen &quot;length&quot;
    &lt;*&gt; gen &quot;damping&quot;
    &lt;*&gt; gen &quot;mass&quot;
    &lt;*&gt; gen &quot;gravity&quot;
  controller &lt;- Controller &lt;$&gt; gen &quot;kd&quot;
  state &lt;- State &lt;$&gt; gen &quot;theta&quot; &lt;*&gt; gen &quot;omega&quot;
  cgReturn $ runController controller system state

genCCode :: IO ()
genCCode = emitController cgGen
  where
    cgGen :: String -&gt; SBVCodeGen SDouble
    cgGen = cgInput</code></pre>
</div>
<div id="generated-c-code" class="slide section level1">
<h1>Generated C code</h1>
<pre><code>SDouble runController(const SDouble length,
                      const SDouble damping, const SDouble mass, const SDouble gravity,
                      const SDouble kd, const SDouble theta, const SDouble omega)
{
  const SDouble s0 = length;
  const SDouble s2 = mass;
  const SDouble s3 = gravity;
  const SDouble s4 = kd;
  const SDouble s5 = theta;
  const SDouble s6 = omega;
  const SDouble s8 = s2 * 2.0;
  const SDouble s9 = s3 * s8;
  const SDouble s10 = s0 * s9;
  const SDouble s12 = s5 * s5;
  const SDouble s13 = s5 * s12;
  const SDouble s15 = s13 / 6.0;
  const SDouble s16 = (- s15);
  const SDouble s17 = 0.0 + s16;
  const SDouble s18 = s5 * s15;
  const SDouble s19 = s5 * s18;
  const SDouble s21 = s19 / 20.0;
  const SDouble s22 = s17 + s21;
  const SDouble s23 = s5 * s21;
  const SDouble s24 = s5 * s23;
  const SDouble s26 = s24 / 42.0;
  const SDouble s27 = (- s26);
  const SDouble s28 = s22 + s27;
  const SDouble s29 = s5 * s26;
  const SDouble s30 = s5 * s29;
  const SDouble s32 = s30 / 72.0;
  const SDouble s33 = s28 + s32;
  const SDouble s34 = s5 * s32;
  const SDouble s35 = s5 * s34;
  const SDouble s37 = s35 / 110.0;
  const SDouble s38 = (- s37);
  const SDouble s39 = s33 + s38;
  const SDouble s40 = s5 * s37;
  const SDouble s41 = s5 * s40;
  const SDouble s43 = s41 / 156.0;
  const SDouble s44 = s39 + s43;
  const SDouble s45 = s5 * s43;
  const SDouble s46 = s5 * s45;
  const SDouble s48 = s46 / 210.0;
  const SDouble s49 = (- s48);
  const SDouble s50 = s44 + s49;
  const SDouble s51 = s5 * s48;
  const SDouble s52 = s5 * s51;
  const SDouble s54 = s52 / 272.0;
  const SDouble s55 = s50 + s54;
  const SDouble s56 = s5 * s54;
  const SDouble s57 = s5 * s56;
  const SDouble s59 = s57 / 342.0;
  const SDouble s60 = (- s59);
  const SDouble s61 = s55 + s60;
  const SDouble s62 = s5 * s59;
  const SDouble s63 = s5 * s62;
  const SDouble s65 = s63 / 420.0;
  const SDouble s66 = s61 + s65;
  const SDouble s67 = s5 + s66;
  const SDouble s68 = s10 * s67;
  const SDouble s69 = (- s68);
  const SDouble s70 = (- s6);
  const SDouble s71 = s4 * s70;
  const SDouble s72 = s69 + s71;

  return s72;
}</code></pre>
</div>
<div id="separate-code-generation-for-taylor-series-functions" class="slide section level1">
<h1>Separate code-generation for Taylor series functions</h1>
<pre><code>emitTaylor f funName gen =
  compileToC Nothing funName $
  gen &quot;x&quot; &gt;&gt;= cgReturn . f</code></pre>
</div>
<div id="separate-code-generation-for-taylor-series-functions-1" class="slide section level1">
<h1>Separate code-generation for Taylor series functions</h1>
<pre><code>emitTaylor f funName gen =
  compileToC Nothing funName $
  gen &quot;x&quot; &gt;&gt;= cgReturn . f</code></pre>
<!-- Now when we generate C code, just add -->
<pre><code>...
emitTaylor taylorSin &quot;taylorSin&quot; cgGen
...</code></pre>
</div>
<div id="separate-code-generation-for-taylor-series-functions-2" class="slide section level1">
<h1>Separate code-generation for Taylor series functions</h1>
<pre><code>emitTaylor f funName gen =
  compileToC Nothing funName $
  gen &quot;x&quot; &gt;&gt;= cgReturn . f</code></pre>
<!--  -->
<pre><code>...
emitTaylor taylorSin &quot;taylorSin&quot; cgGen
...</code></pre>
<!-- Make the function available in Haskell: -->
<pre><code>taylorSin&#39; :: (Fractional a, SymWord a) =&gt; SBV a -&gt; SBV a
taylorSin&#39; = cgUninterpret &quot;taylorSin&quot; mempty taylorSin</code></pre>
</div>
<div id="separate-code-generation-for-taylor-series-functions-sine" class="slide section level1">
<h1>Separate code-generation for Taylor series functions (sine)</h1>
<pre><code>SDouble taylorSin(const SDouble x)
{
  const SDouble s0 = x;
  const SDouble s2 = s0 * s0;
  const SDouble s3 = s0 * s2;
  const SDouble s5 = s3 / 6.0;
  const SDouble s6 = (- s5);
  const SDouble s7 = 0.0 + s6;
  const SDouble s8 = s0 * s5;
  const SDouble s9 = s0 * s8;
  const SDouble s11 = s9 / 20.0;
  const SDouble s12 = s7 + s11;
  const SDouble s13 = s0 * s11;
  const SDouble s14 = s0 * s13;
  const SDouble s16 = s14 / 42.0;
  const SDouble s17 = (- s16);
  const SDouble s18 = s12 + s17;
  const SDouble s19 = s0 * s16;
  const SDouble s20 = s0 * s19;
  const SDouble s22 = s20 / 72.0;
  const SDouble s23 = s18 + s22;
  const SDouble s24 = s0 * s22;
  const SDouble s25 = s0 * s24;
  const SDouble s27 = s25 / 110.0;
  const SDouble s28 = (- s27);
  const SDouble s29 = s23 + s28;
  const SDouble s30 = s0 * s27;
  const SDouble s31 = s0 * s30;
  const SDouble s33 = s31 / 156.0;
  const SDouble s34 = s29 + s33;
  const SDouble s35 = s0 * s33;
  const SDouble s36 = s0 * s35;
  const SDouble s38 = s36 / 210.0;
  const SDouble s39 = (- s38);
  const SDouble s40 = s34 + s39;
  const SDouble s41 = s0 * s38;
  const SDouble s42 = s0 * s41;
  const SDouble s44 = s42 / 272.0;
  const SDouble s45 = s40 + s44;
  const SDouble s46 = s0 * s44;
  const SDouble s47 = s0 * s46;
  const SDouble s49 = s47 / 342.0;
  const SDouble s50 = (- s49);
  const SDouble s51 = s45 + s50;
  const SDouble s52 = s0 * s49;
  const SDouble s53 = s0 * s52;
  const SDouble s55 = s53 / 420.0;
  const SDouble s56 = s51 + s55;
  const SDouble s57 = s0 + s56;

  return s57;
}</code></pre>
</div>
<div id="separate-code-generation-for-taylor-series-functions-controller" class="slide section level1">
<h1>Separate code-generation for Taylor series functions (controller)</h1>
<pre><code>SDouble runController(const SDouble length,
                      const SDouble damping, const SDouble mass, const SDouble gravity,
                      const SDouble kd, const SDouble theta, const SDouble omega)
{
  const SDouble s0 = length;
  const SDouble s2 = mass;
  const SDouble s3 = gravity;
  const SDouble s4 = kd;
  const SDouble s5 = theta;
  const SDouble s6 = omega;
  const SDouble s8 = s2 * 2.0;
  const SDouble s9 = s3 * s8;
  const SDouble s10 = s0 * s9;
  const SDouble s11 = /* Uninterpreted function */ taylorSin(s5);
  const SDouble s12 = s10 * s11;
  const SDouble s13 = (- s12);
  const SDouble s14 = (- s6);
  const SDouble s15 = s4 * s14;
  const SDouble s16 = s13 + s15;

  return s16;
}</code></pre>
</div>
<div id="constraint-solving" class="slide section level1">
<h1>Constraint solving</h1>
<!-- Who knows what the upside-down A "$\Huge \forall$" means?  How about -->
<!-- the backwards E "$\Huge \exists$"? -->
<!-- Trick question: these two are actually opposites of each other.  For a -->
<!-- theorem we've stated using $\Huge \forall$, we can replace this with -->
<!-- $\Huge \exists$ and get a constraint problem.  SBV can easily solve -->
<!-- these problems for us too. -->
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cforall" alt="\Huge \forall" title="\Huge \forall" /></p>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cexists" alt="\Huge \exists" title="\Huge \exists" /></p>
</div>
<div id="constraint-solving-1" class="slide section level1">
<h1>Constraint solving</h1>
<p><img style="vertical-align:middle" src="https://latex.codecogs.com/png.latex?%5CHuge%20%5Cforall%20x.%20p%28x%29%20%5Cto%20%5Cexists%20x.%20p%28x%29" alt="\Huge \forall x. p(x) \to \exists x. p(x)" title="\Huge \forall x. p(x) \to \exists x. p(x)" /></p>
</div>
<div id="send-more-money" class="slide section level1">
<h1>SEND + MORE = MONEY</h1>
<!-- (This is an example from the SBV library.)  You may remember this one -->
<!-- from your school days: -->
<pre><code>sendMoreMoney :: IO AllSatResult
sendMoreMoney = allSat $ do
  ds@[s,e,n,d,m,o,r,y] &lt;- sIntegers $ pure &lt;$&gt; [&quot;sendmory&quot;]
  let
    isDigit x = x .&gt;= 0 &amp;&amp;&amp; x .&lt;= 9
    val xs    = sum $ zipWith (*)
                  (reverse xs)
                  (iterate (*10) 1)
    send      = val [s,e,n,d]
    more      = val [m,o,r,e]
    money     = val [m,o,n,e,y]
  constrain $ bAll isDigit ds
  constrain $ distinct ds
  constrain $ s ./= 0 &amp;&amp;&amp; m ./= 0
  solve [send + more .== money]</code></pre>
</div>
<div id="send-more-money-1" class="slide section level1">
<h1>SEND + MORE = MONEY</h1>
<pre><code>sendMoreMoney :: IO AllSatResult
sendMoreMoney = allSat $ do
  ds@[s,e,n,d,m,o,r,y] &lt;- sIntegers $ pure &lt;$&gt; [&quot;sendmory&quot;]
  let
    isDigit x = x .&gt;= 0 &amp;&amp;&amp; x .&lt;= 9
    val xs    = sum $ zipWith (*)
                  (reverse xs)
                  (iterate (*10) 1)
    send      = val [s,e,n,d]
    more      = val [m,o,r,e]
    money     = val [m,o,n,e,y]
  constrain $ bAll isDigit ds
  constrain $ distinct ds
  constrain $ s ./= 0 &amp;&amp;&amp; m ./= 0
  solve [send + more .== money]</code></pre>
<!-- Just set up the problem and let Z3 do its thing: -->
<pre><code> SendMoreMoney&gt; sendMoreMoney
 Solution #1:
   s = 9 :: Integer
   e = 5 :: Integer
   n = 6 :: Integer
   d = 7 :: Integer
   m = 1 :: Integer
   o = 0 :: Integer
   r = 8 :: Integer
   y = 2 :: Integer</code></pre>
</div>
<div id="more-constraint-solving-problems" class="slide section level1">
<h1>More constraint solving problems</h1>
<p>Please check out the SBV documentation for more constraint problem examples, including:</p>
<ul>
<li>n-queens</li>
<li>sudoku</li>
<li>“Cheryl’s birthday problem”</li>
<li>knapsack-type problems</li>
</ul>
</div>
<div id="optimization" class="slide section level1">
<h1>Optimization</h1>
<!-- SBV can also solve optimization problems!  This relies on Z3's -->
<!-- built-in support for optimization, which only works over integral and -->
<!-- algebraic real metrics (meaning you can't optimize floating-point -->
<!-- objectives).  Here's a simple integer linear programming problem: -->
<p>A simple integer linear programming (ILP) problem:</p>
<pre><code>optimize Lexicographic $ do
  x &lt;- sInteger &quot;x&quot;
  y &lt;- sInteger &quot;y&quot;
  constrain $ x .&gt; 0
  constrain $ x .&lt; 6
  constrain $ y .&gt; 2
  constrain $ y .&lt; 12
  minimize &quot;goal&quot; $ x + 2 * y</code></pre>
</div>
<div id="optimization-1" class="slide section level1">
<h1>Optimization</h1>
<p>A simple integer linear programming (ILP) problem:</p>
<pre><code>optimize Lexicographic $ do
  x &lt;- sInteger &quot;x&quot;
  y &lt;- sInteger &quot;y&quot;
  constrain $ x .&gt; 0
  constrain $ x .&lt; 6
  constrain $ y .&gt; 2
  constrain $ y .&lt; 12
  minimize &quot;goal&quot; $ x + 2 * y</code></pre>
<!--  -->
<pre><code>Optimal model:
  x    = 1 :: Integer
  y    = 3 :: Integer
  goal = 7 :: Integer</code></pre>
<!-- (The `Lexicographic` option specifies how to handle multiple -->
<!-- objectives, in case you want to e.g. find Pareto fronts.  For this -->
<!-- problem it's irrelevant.) -->
</div>
<div id="resources" class="slide section level1">
<h1>Resources</h1>
<p>See Wikipedia for an overview of <strong>SAT</strong> and <strong>SMT</strong></p>
<p>SMTLIB homepage: http://smtlib.cs.uiowa.edu/</p>
<p>SBV homepage: https://leventerkok.github.io/sbv/</p>
<p>SBV hackage docs: https://hackage.haskell.org/package/sbv</p>
<p>Z3 homepage: https://github.com/Z3Prover/z3/wiki</p>
<p>These slides: https://peddie.github.io/smt-solving/</p>
<p>Slide repository, code, etc.: https://github.com/peddie/smt-solving</p>
</div>
<div id="backups" class="slide section level1">
<h1>BACKUPS</h1>
</div>
<div id="taylor-series-functions" class="slide section level1">
<h1>Taylor Series functions</h1>
<p>10th-order Taylor series approximation to the basic trig functions:</p>
<pre><code>taylorCos :: Fractional a =&gt; a -&gt; a
taylorCos x = 1 + sum (take 10 series)
  where
    inc num old =
      let new = old * x * x / (num * (num + 1))
      in new : inc (num + 2) new
    signs = cycle [negate, id]
    series = zipWith ($) signs (inc 1 1)

taylorSin :: Fractional a =&gt; a -&gt; a
taylorSin x = x + sum (take 10 series)
  where
    inc num old =
      let new = old * x * x / (num * (num + 1))
      in new : inc (num + 2) new
    signs = cycle [negate, id]
    series = zipWith ($) signs (inc 2 x)</code></pre>
</div>
<div id="regexp-crosswords" class="slide section level1">
<h1>Regexp Crosswords</h1>
<p>(Here is another example that ships with SBV.) How many people are familiar with regexp crosswords?</p>
<div class="figure">
<img src="regexp-crossword.png" title="Regular expression crossword" alt="Regular expression crossword" />
<p class="caption">Regular expression crossword</p>
</div>
<p><a href="https://regexcrossword.com/challenges/intermediate/puzzles/1" class="uri">https://regexcrossword.com/challenges/intermediate/puzzles/1</a></p>
</div>
<div id="regexp-crossword-solution-part-1" class="slide section level1">
<h1>Regexp Crossword solution (part 1)</h1>
<pre><code>import qualified Data.SBV.String as S
import qualified Data.SBV.RegExp as R

-- | Solve a given crossword, returning the corresponding rows
solveCrossword :: [R.RegExp] -&gt; [R.RegExp] -&gt; IO [String]
solveCrossword rowRegExps colRegExps = runSMT $ do
        let numRows = genericLength rowRegExps
            numCols = genericLength colRegExps

        -- constrain rows
        let mkRow rowRegExp = do row &lt;- free_
                                 constrain $ row `R.match` rowRegExp
                                 constrain $ S.length row .== literal numCols
                                 return row

        rows &lt;- mapM mkRow rowRegExps

        -- constrain colums
        let mkCol colRegExp = do col &lt;- free_
                                 constrain $ col `R.match` colRegExp
                                 constrain $ S.length col .== literal numRows
                                 return col

        cols &lt;- mapM mkCol colRegExps</code></pre>
</div>
<div id="regexp-crossword-solution-part-2" class="slide section level1">
<h1>Regexp crossword solution (part 2)</h1>
<pre><code>. . .

        -- constrain each &quot;cell&quot; as they rows/columns intersect:
        let rowss =           [[r .!! literal i | i &lt;- [0..numCols-1]] | r &lt;- rows]
        let colss = transpose [[c .!! literal i | i &lt;- [0..numRows-1]] | c &lt;- cols]

        constrain $ bAnd $ zipWith (.==) (concat rowss) (concat colss)

        -- Now query to extract the solution
        query $ do cs &lt;- checkSat
                   case cs of
                     Unk   -&gt; error &quot;Solver returned unknown!&quot;
                     Unsat -&gt; error &quot;There are no solutions to this puzzle!&quot;
                     Sat   -&gt; mapM getValue rows</code></pre>
</div>
<div id="compiler-plugin" class="slide section level1">
<h1>Compiler plugin</h1>
<p>The SBV library is also available as a GHC plugin, which runs at compile time and can accept program annotations telling it what parts of the program to prove. This lets you integrate theorem-proving into the compilation phase of your system.</p>
</div>
</body>
</html>
